<!DOCTYPE html>  <html> <head>   <title>feedparser-stream.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               feedparser-stream.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>node-feedparser-stream
Copyright(c) 2012 Philipp Spie√ü <a href="&#109;&#97;&#105;l&#116;&#111;:&#104;e&#x6C;&#108;&#x6F;&#x40;&#112;&#x68;&#105;l&#105;&#x70;p&#x73;&#112;&#x69;&#x65;&#x73;&#x73;&#x2E;&#x63;&#111;&#109;">&#104;e&#x6C;&#108;&#x6F;&#x40;&#112;&#x68;&#105;l&#105;&#x70;p&#x73;&#112;&#x69;&#x65;&#x73;&#x73;&#x2E;&#x63;&#111;&#109;</a>
MIT Licensed</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">FeedParser = </span><span class="nx">require</span> <span class="s">&#39;feedparser&#39;</span>
<span class="nv">events = </span><span class="nx">require</span> <span class="s">&#39;events&#39;</span>
<span class="nv">_ = </span><span class="nx">require</span> <span class="s">&#39;underscore&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>This class combines all the power and magic of <code>feedparser</code> and <code>EventEmitter</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">FeedParserStream</span> <span class="k">extends</span> <span class="nx">events</span><span class="p">.</span><span class="nx">EventEmitter</span>
  </pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>The <strong>constuctor</strong>. </p>

<p>Its first argument is optional and an object of options, see the default options.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="nf">(options) -&gt;</span>
    <span class="nx">unless</span> <span class="nx">options</span><span class="o">?</span>
      <span class="nv">options = </span><span class="p">{}</span>

    <span class="vi">@opt = </span><span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span> <span class="nx">options</span><span class="p">,</span>
      <span class="nv">includeFirst: </span><span class="kc">true</span>
      <span class="nv">interval: </span><span class="mi">60000</span> <span class="c1"># Every minute</span>
      <span class="nv">debug: </span><span class="kc">false</span>
    
    <span class="vi">@parser = </span><span class="k">new</span> <span class="nx">FeedParser</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>This will <strong>fetch an url</strong> and all it's articles.</p>

<p>If options.includeFirst is set to null we will skip pushing these articles
but still need to fetch them to find out what is the latest one.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">parseUrl: </span><span class="p">(</span><span class="nx">@url</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nx">@parser</span><span class="p">.</span><span class="nx">parseUrl</span> <span class="nx">@url</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">meta</span><span class="p">,</span> <span class="nx">articles</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">if</span> <span class="nx">err</span><span class="o">?</span>
        <span class="k">throw</span> <span class="nx">err</span>
      <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>The last one should be fired at first, this is because we want a streaming feeling :)</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">articles = </span><span class="nx">articles</span><span class="p">.</span><span class="nx">reverse</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Now it's time to save tha last one and push it to the client ;)</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">for</span> <span class="nx">article</span> <span class="k">in</span> <span class="nx">articles</span>
          <span class="k">if</span> <span class="nx">@opt</span><span class="p">.</span><span class="nx">includeFirst</span>
            <span class="nx">@emit</span> <span class="s">&#39;article&#39;</span><span class="p">,</span> <span class="nx">article</span>
          <span class="vi">@last = </span><span class="nx">article</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Now it's time to start the polling, good luck!</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">@poll</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p><strong>Poll</strong> it!</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">poll: </span><span class="o">=&gt;</span>
    <span class="vi">@timeout = </span><span class="nx">_</span><span class="p">.</span><span class="nx">delay</span> <span class="nx">@operate</span><span class="p">,</span> <span class="nx">@opt</span><span class="p">.</span><span class="nx">interval</span>     </pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>This will <strong>exit the stream</strong></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">exit: </span><span class="o">=&gt;</span>
    <span class="nx">clearTimeout</span> <span class="nx">@timeout</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>This will be called every interval.</p>

<p>We <strong>fetch the newest article</strong> and see what changed.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">operate: </span><span class="o">=&gt;</span>
    <span class="nx">@parser</span><span class="p">.</span><span class="nx">parseUrl</span> <span class="nx">@url</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">meta</span><span class="p">,</span> <span class="nx">articles</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">if</span> <span class="nx">err</span><span class="o">?</span>
        <span class="k">throw</span> <span class="nx">err</span>
      <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Again, we need to start with the last one</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">articles = </span><span class="nx">articles</span><span class="p">.</span><span class="nx">reverse</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>This is a little bit dirty.</p>

<p>To check for the newest article i take an empty array and fill it with all the articles,
which are not equal to the last article. There may be older articles, therefore we have
to reset the array if we find an equivalent. </p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">new_articles = </span><span class="p">[]</span>
        <span class="k">for</span> <span class="nx">article</span> <span class="k">in</span> <span class="nx">articles</span>
          <span class="k">if</span> <span class="nx">@equals</span> <span class="nx">article</span><span class="p">,</span> <span class="nx">@last</span>
            <span class="nv">new_articles = </span><span class="p">[]</span>
          <span class="k">else</span>
            <span class="nx">new_articles</span><span class="p">.</span><span class="nx">push</span> <span class="nx">article</span>

        <span class="k">if</span> <span class="nx">@opt</span><span class="p">.</span><span class="nx">debug</span>
          <span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">write</span> <span class="s">&#39;.&#39;</span>

        <span class="k">for</span> <span class="nx">article</span> <span class="k">in</span> <span class="nx">new_articles</span>
          <span class="nx">@emit</span> <span class="s">&#39;article&#39;</span><span class="p">,</span> <span class="nx">article</span>
          <span class="vi">@last = </span><span class="nx">article</span>

        <span class="nx">@poll</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Find out <strong>if two articles are equal</strong></p>

<p>@Todo: find a good algorithm if something changes</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">equals: </span><span class="p">(</span><span class="nx">article1</span><span class="p">,</span> <span class="nx">article2</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="k">if</span> <span class="nx">article1</span><span class="p">.</span><span class="nx">link</span> <span class="o">is</span> <span class="nx">article2</span><span class="p">.</span><span class="nx">link</span>
      <span class="kc">true</span>
    <span class="k">else</span>
      <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Over and out</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">module.exports = </span><span class="nx">FeedParserStream</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 